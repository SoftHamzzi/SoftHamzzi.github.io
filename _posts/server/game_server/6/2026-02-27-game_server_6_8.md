---
title:  "[κ²μ„ μ„λ²„] 6.8 ν΄λΌμ΄μ–ΈνΈλΌλ¦¬ P2P ν†µμ‹ "
excerpt: "6.8"

categories:
  - GameServer
tags:
  - [GameServer]

toc: true
toc_sticky: true
 
date: 2026-02-27
last_modified_at: 2026-02-27
---
# π“¦ 6. κ²μ„ λ„¤νΈμ›ν¬ μ—”μ§„ ν”„λΌμ°λ“λ„·
## π‘‰π» 8. μμ‹: μ±„ν… μ²λ¦¬

### π“ μ±„ν… μ²λ¦¬ νλ¦„

```mermaid
sequenceDiagram
    participant C1 as ν΄λΌμ΄μ–ΈνΈ1
    participant S as μ„λ²„
    participant C2 as ν΄λΌμ΄μ–ΈνΈ2
    participant C3 as ν΄λΌμ΄μ–ΈνΈ3

    C1->>S: β‘  Chat()
    activate S

    S->>C2: β‘΅ ShowChat()
    activate C2
    deactivate C2

    S->>C3: β‘Ά ShowChat()
    activate C3
    deactivate C3

    deactivate S

```

**κΈ°λ³Έ κµ¬μ΅°:**
- μ„λ²„λ” ν΄λΌμ΄μ–ΈνΈμ—κ² λ©”μ‹μ§€λ¥Ό μμ‹ λ°›κ³ , λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ—κ² λΏλ ¤μ£Όλ” ν•μ‹μΌλ΅ κµ¬ν„ν•λ‹¤

---

### π–¥οΈ μ„λ²„ μΈ΅ μμ‚¬ μ½”λ“

#### κΈ°λ³Έ κµ¬μ΅°

```cpp
class MyGameServer {
	CNetServer* m_netServer;
	CriticalSection m_critSec;
	map<HostID, shared_ptr<RemoteClient>> m_remoteClients;
	
	OnClientJoin(clientInfo) {
		CriticalSectionLock lock(m_critSec, true);
		shared_ptr<RemoteClient> newRemote =
			shared_ptr<RemoteClient>(new RemoteClient);
		fill_something(newRemote);
		m_remoteClients.Add(clientInfo->m_hostID, newRemote);
	}
	
	OnClientLeave(clientInfo) {
		CriticalSectionLock lock(m_critSec, true);
		m_remoteClients.Remove(clientInfo->m_hostID);
	}
	
	Init() {
		m_netServer->OnClientJoin = OnClientJoin;
		m_netServer->OnClientLeave = OnClientLeave;
	}
}

```

**ν•µμ‹¬ μ‚¬ν•­:**
- CNetServerλ” κΈ°λ³Έμ μΌλ΅ **λ©€ν‹°μ¤λ λ“**λ΅ μ‘λ™ν•λ©°, μ‹±κΈ€μ¤λ λ“λ΅ λ§λ“¤ μλ„ μλ‹¤
- `m_remoteClients`λ΅ μ ‘μ†ν• ν΄λΌμ΄μ–ΈνΈλ“¤μ λ©λ΅μ„ μ €μ¥ν•λ‹¤
- `CriticalSectionLock`μΌλ΅ λ°μ΄ν„°λ¥Ό λ³΄νΈν•λ‹¤
    - RMIλ‚ μ΄λ²¤νΈ ν•¨μ νΈμ¶μ΄ μ—¬λ¬ μ¤λ λ“μ—μ„ μ‹¤ν–‰λκΈ° λ•λ¬Έ
- `OnClientJoin()`/`OnClientLeave()` ν•¨μμ—μ„ ν΄λΌμ΄μ–ΈνΈ μ ‘μ†/ν‡΄μ¥μ„ μ²λ¦¬ν•λ‹¤

---

#### μ±„ν… μ²λ¦¬

```cpp
class RemoteClient {
	string m_name;
};

MyGameServer:public MyGameC2S::Stub {
	MyGameS2C::Proxy m_s2cProxy;
	
	MyGameC2S:Stub::Chat(senderHostID, rmiContext, text) {
		CriticalSectionLock lock(m_critSec, true);
		
		// 1
		shared_ptr<RemoteClient> sender =
			m_remoteClients.find(senderHostID).second;
		
		// 2
		vector<HostID> sendTo;
		for(auto r : m_remoteClients) {
			if(r.first != senderHostID)
				sendTo.push_back(r.first);
		}
		
		// 3
		m_s2cProxy.ShowChat(&r[0], r.size(), sender->m_name, text);
	}
}

```

**μ²λ¦¬ κ³Όμ •:**
- **1λ²**: senderHostIDλ¥Ό ν†µν•΄ μ†΅μ‹ μμ μ •λ³΄λ¥Ό μ•μ•„λ‚Έλ‹¤
- **2λ²**: μ†΅μ‹ μλ¥Ό μ μ™Έν• ν΄λΌμ΄μ–ΈνΈλ“¤, μ¦‰ μμ‹ μ λ©λ΅μ„ λ§λ“ λ‹¤
- **3λ²**: λ©€ν‹°μΊμ¤νΈλ¥Ό μ§„ν–‰ν•λ‹¤

---

### π’» ν΄λΌμ΄μ–ΈνΈ μΈ΅ μμ‚¬ μ½”λ“

```cpp
class MyGameClient {
	CNetServer* m_netClient;
	
	OnJoinServerComplete(info, replyFromServer) {
		if(info.type == OK)
			do_success();
		else
			do_failure();
	}
	
	OnLeaveServer(info) {
		do_leave();
	}
	
	Init() {
		m_netClient->OnJoinServerComplete = OnJoinServerComplete
		m_netClient->OnLeaveServer = OnLeaveServer;
	}
	
	MainLoop() {
		while(true) {
			m_netClient->FrameMove();
			update_scene();
			render_scene();
		}
	}
}

```

**ν•µμ‹¬ μ‚¬ν•­:**
- `FrameMove()` ν•¨μμ—μ„ μ΄λ²¤νΈ λ° μμ‹  μ²λ¦¬λ¥Ό μ§„ν–‰ν•λ‹¤
- `OnJoinServerComplete()`/`OnLeaveServer()` ν•¨μμ—μ„ μ„λ²„ μ—°κ²° μ—¬λ¶€/μ—°κ²° μ¤‘λ„ ν•΄μ λ¥Ό μ²λ¦¬ν•λ‹¤
    - μ§μ ‘ κµ¬ν„ν•λ‹¤

---

# π§ μ •λ¦¬

**μ„λ²„ μ—­ν• :**
- ν΄λΌμ΄μ–ΈνΈ λ©λ΅ κ΄€λ¦¬ (μ ‘μ†/ν‡΄μ¥)
- μ±„ν… λ©”μ‹μ§€ μμ‹  λ° λ©€ν‹°μΊμ¤νΈ
- λ©€ν‹°μ¤λ λ“ ν™κ²½μ—μ„ λ°μ΄ν„° λ³΄νΈ

**ν΄λΌμ΄μ–ΈνΈ μ—­ν• :**
- μ„λ²„ μ—°κ²°/ν•΄μ  μ²λ¦¬
- FrameMove()λ΅ μ΄λ²¤νΈ ν΄λ§
- λ©”μ‹μ§€ μμ‹  λ° ν™”λ©΄ μ—…λ°μ΄νΈ

**ν•µμ‹¬ ν¨ν„΄:**
- μ„λ²„ μ¤‘μ‹¬ λ©”μ‹μ§€ μ¤‘κ³„
- λ©€ν‹°μΊμ¤νΈλ΅ ν¨μ¨μ  μ „μ†΅
- μ¤λ λ“ μ•μ „μ„± λ³΄μ¥